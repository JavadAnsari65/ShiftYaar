# راهنمای جامع سامانه برنامه‌ریزی شیفت بیمارستان

این سند برای مدیران مراکز درمانی و تیم‌های فنی نوشته شده تا بدانند سامانه «شیفت‌یار» چگونه طراحی شده، چه پیش‌نیازهایی دارد، چطور باید راه‌اندازی شود و در عمل چگونه می‌تواند ترکیب پیچیده‌ای از قوانین نیروی انسانی و محدودیت‌های بالینی را پوشش دهد.

---

## ۱. معرفی سامانه

- **هدف کلیدی:** بهینه‌سازی چیدمان شیفت‌ها برای پرسنل بالینی با درنظرگرفتن الزامات بهره‌وری، نیازهای دپارتمان‌ها و محدودیت‌های انسانی/قانونی.
- **معماری:** بر اساس Clean Architecture → لایه Domain (قوانین اصلی)، Application (سرویس‌ها و Use-Caseها)، Infrastructure (دیتابیس و سرویس‌های جانبی) و Api (ارائه REST).
- **الگوریتم‌ها:** سه موتور زمان‌بندی قابل انتخاب:
  1. شبیه‌سازی تبرید (Simulated Annealing) برای جست‌وجوی تصادفی کنترل‌شده.
  2. Hybrid Scheduler (ترکیب OR-Tools و SA).
  3. حل‌کننده‌ی قید محور OR-Tools/CPSat برای سناریوهای دقیق با محدودیت زیاد.

---

## ۲. پیش‌نیازها و داده‌های اولیه

| داده/تنظیم | محل ثبت | توضیح |
| --- | --- | --- |
| پرسنل، نقش‌ها، تخصص‌ها | ماژول User/Specialty | باید برای هر کاربر اطلاعات جنسیت، سابقه، امکان شیفت شب و … کامل شود. |
| دپارتمان و ظرفیت | ماژول Department | شامل قیود خاص هر بخش (مثلاً حداقل یک پرستار ارشد در هر شیفت). |
| تنظیمات شیفت | `DepartmentSchedulingSettings` | قانون‌های Hard/Soft، سقف شیفت شب، فاصله استراحت و … |
| ساعات موظفی بهره‌وری | `StaffEmploymentInfoDto` + سرویس Productivity | برای هر ماه باید عدد هفته‌ها، ساعات شب و فیلدهای سختی کار پر شود. |
| تعطیلات رسمی | `ShiftYar.Api/Resources/Holidays` | برای اعمال ضرایب ۱.۵ و مدیریت ظرفیت روزهای تعطیل. |

> **نکته:** قبل از اجرای هر الگوریتم، تعمیر دیتای پایه الزامی است؛ الگوریتم‌ها فرض می‌کنند تمامی IDها معتبر و روابط موجود هستند.

---

## ۳. فرایند کلی کار سیستم

1. **جمع‌آوری داده‌ها:** API یا داشبورد مدیریتی اطلاعات کاربران، تخصص‌ها، درخواست‌های مرخصی و اولویت‌ها را دریافت می‌کند.
2. **محاسبه موظفی بهره‌وری:** سرویس `WorkingHoursCalculator` برای هر نیروی بالینی ساعات موظفی ماهانه را بر اساس آیین‌نامه بهره‌وری ایران محاسبه می‌کند.
3. **ساخت قیود:** کلاس `ShiftConstraints` قیود سفت‌وسخت (Hard) و ترجیحات (Soft) را از تنظیمات دپارتمان و داده‌های کاربر استخراج می‌کند و از این نسخه به بعد مقدار `FinalMonthlyRequiredHours` خروجی سرویس بهره‌وری برای هر کاربر به عنوان سقف قانونی در همین مرحله تزریق می‌شود.
4. **اجرای الگوریتم:** یکی از موتورهای SimulatedAnnealing / Hybrid / OrTools بر اساس پارامترهای ذخیره‌شده در دیتابیس اجرا می‌شود.
5. **تولید خروجی:** نتیجه شامل جدول نهایی شیفت‌ها، آماری از نقض قیود و متادیتای الگوریتم انتخابی است.
6. **بازبینی انسانی:** سوپروایزر می‌تواند خروجی را در UI مشاهده و در صورت نیاز تغییرات دستی اعمال کند.

---

## ۴. جزئیات الگوریتم‌ها و نحوه انتخاب

| الگوریتم | نقاط قوت | محدودیت‌ها | سناریوی پیشنهادی |
| --- | --- | --- | --- |
| Simulated Annealing | سرعت بالا در داده‌های متوسط، امکان فرار از مینیمم محلی | کیفیت وابسته به پارامترهای دما و تکرار | وقتی قیود نرم زیاد و انعطاف نیاز است. |
| OR-Tools CPSat | تضمین بهینگی، پشتیبانی از قیود پیچیده | حساس به حجم داده و زمان حل طولانی | زمانی که قیود قانونی شکست‌ناپذیر هستند (ICU، اتاق عمل). |
| Hybrid | ترکیب جست‌وجوی دقیق و اکتشافی | نیازمند تنظیم دقیق دو موتور | برای سناریوهای بزرگ که هم کیفیت هم سرعت اهمیت دارد. |

**پیکربندی:** همه پارامترها در جدول `AlgorithmSettings` ذخیره می‌شوند و از طریق `IAlgorithmSettingsService` به لایه Application تزریق می‌گردند.

---

## ۵. نحوه استفاده‌ی عملی (گام‌به‌گام)

1. **ثبت داده پایه** (کاربر، دپارتمان، تخصص، الگوهای شیفت، تعطیلات).
2. **وارد کردن تنظیمات دپارتمان:** استفاده از API `DepartmentSchedulingSettings` برای تعیین سقف شیفت شب، اولویت جنسیت و … .
3. **محاسبه ساعات موظفی:** برای هر ماه، سرویس Productivity را صدا بزنید:
   ```csharp
   var request = new WorkingHoursCalculationRequestDto
   {
       TargetMonth = new DateTime(2025, 10, 1),
       NumberOfWeeksInMonth = 4,
       NightHolidayHours = 32,
       Staff = staffEmploymentInfoDto
   };
   var result = _workingHoursCalculator.CalculateMonthlyHours(request);
   ```
4. **ارسال درخواست زمان‌بندی:** `ShiftSchedulingRequestDto` را با شناسه دپارتمان، بازه تاریخ و الگوریتم منتخب پر کنید.
5. **انتظار برای حل:** سرویس `ShiftSchedulingService.ScheduleAsync()` خروجی را به صورت DTO برمی‌گرداند.
6. **بازبینی و اعمال تغییر:** می‌توان از API‌های `ShiftRequestService` برای ثبت اعتراض/مرخصی جدید استفاده کرد و سپس الگوریتم را مجدداً اجرا نمود.

---

## ۶. چالش‌های توسعه و راهکارها

| چالش | وضعیت فعلی | راهکار پیشنهادی |
| --- | --- | --- |
| همگام‌سازی بهره‌وری با الگوریتم‌ها | ✅ خروجی Productivity اکنون به‌صورت مستقیم در `ShiftConstraints` و الگوریتم‌ها اعمال می‌شود. | امکان تنظیم‌پذیری بیشتر ضرایب نرم بر اساس سناریوهای بیمارستانی. |
| حجم بالای داده | موتور OR-Tools ممکن است روی دپارتمان‌های بسیار بزرگ کند شود. | استفاده از Hybrid با تقسیم بازه زمانی (Rolling Horizon) یا اعمال Pre-Filter برای کاربران غیر فعال. |
| رخدادهای لحظه‌ای (اضطراری) | نیاز به اجرای دوباره کل الگوریتم دارد. | توسعه ماژول «Re-Scheduling» برای جابه‌جایی محدود در بازه‌های کوتاه. |
| آزمون‌پذیری | تست‌های خودکار محدود است. | افزودن سناریوهای Unit/Integration برای Productivity و الگوریتم‌ها. |

---

## ۷. مشکلات شناخته‌شده و پیشنهادات بهبود

1. **کنترل ساعات بهره‌وری:** خروجی `WorkingHoursCalculationResultDto` اکنون به عنوان Hard/Soft Constraint اعمال و هرگونه مازاد در KPIها گزارش می‌شود.
2. **مدیریت تعطیلات/شیفت‌های ویژه:** اگرچه فایل `Holidays` موجود است، اما موتور الگوریتم صرفاً از وزن نرم استفاده می‌کند؛ لازم است برای ایام رسمی Hard Constraint تعریف شود.
3. **پشتیبانی از تغییرات لحظه‌ای:** API فعلی Request/Response همواره batch-oriented است؛ پیشنهاد می‌شود صف پیام (مانند RabbitMQ) برای Trigger کردن re-run جزئی اضافه شود.
4. **اعتبارسنجی داده ورودی:** DTOهای اصلی اکنون دارای Validation Attribute و منطق `IValidatableObject` هستند؛ با این حال اتصال FluentValidation در لایه API برای خطاهای محلی‌سازی‌شده پیشنهاد می‌شود.
5. **KPIهای نظارتی:** علاوه بر `AlgorithmStatus`، شاخص‌هایی مثل `ProductivityComplianceRate`، `WorkedHoursByUser` و `SoftConstraintViolationRate` در خروجی زمان‌بندی اضافه شده‌اند و قابل مانیتور هستند.

---

## ۸. نکات عملیاتی

- قبل از اجرای الگوریتم‌ها، از طریق `ShiftYar.Api/Controllers/Settings` مطمئن شوید تنظیمات هر دپارتمان به‌روز است.
- در محیط‌های بزرگ، از `HybridParameters.MaxIterations` کوچک‌تر استفاده کنید تا سیستم UI قفل نشود.
- لاگ‌های OrTools در مسیر `ShiftYar.Api/logs` ذخیره می‌شود؛ برای عیب‌یابی حتماً سطح LogSearchProgress را فعال نمایید.
- برای رعایت حریم خصوصی، دسترسی به داده‌های پرسنلی باید از طریق نقش‌های `Admin` و `Supervisor` محدود شود (ماژول Auth این قابلیت را دارد).

---

## ۹. ماژول Re-scheduling اضطراری (Rolling Horizon)

- **هدف:** بازتنظیم سریع شیفت‌ها در سناریوهایی مثل غیبت اضطراری، اشباع بخش یا رخدادهای بحرانی بدون اجرای مجدد کل بازه.
- **رویکرد:** بازه موردنظر به پنجره‌های کوچک‌تر (۷ روزه با همپوشانی قابل تنظیم) خرد می‌شود و برای هر پنجره یکی از الگوریتم‌های اصلی اجرا می‌گردد. خروجی پنجره‌ها با قاعده «آخرین پنجره غالب است» ترکیب می‌شود.
- **API جدید:** `POST /api/EmergencyRescheduling/rolling-horizon` که `EmergencyReschedulingRequestDto` را دریافت می‌کند. پارامترها شامل `WindowSizeDays`, `OverlapDays` و `ImpactedUserIds` هستند.
- **خروجی:** `RollingHorizonRescheduleResultDto` شامل فهرست تجمیع‌شده‌ی انتساب‌ها، KPI هر پنجره (از جمله `ProductivityComplianceRate`) و مجموع زمان حل (`TotalSolveTime`).
- **سناریو پیشنهادی:** برای ICU زمانی که ۳ نفر از شیفت شب به‌طور ناگهانی خارج می‌شوند، می‌توان بازه ۱۰ روزه آینده را با پنجره‌های ۵ روزه و همپوشانی ۲ روزه بازتنظیم کرد و فقط تغییرات مربوط به آن کاربران را به UI برگرداند.

### ۹.۱ تنظیم رفتار کمبود نیرو پس از رسیدن به سقف موظفی

در نسخه‌ی جدید می‌توانید تعیین کنید وقتی تمام کارکنان به سقف ساعات بهره‌وری رسیده‌اند، شیفت‌های باقی‌مانده چه سرنوشتی داشته باشند:

| حالت | تنظیمات | نتیجه |
| --- | --- | --- |
| **سخت‌گیرانه (پیش‌فرض)** | در `DepartmentSchedulingSettings` مقدار `EnforceProductivityHours = true` بگذارید (یا بدون override رها کنید). | الگوریتم به محض رسیدن هر کاربر به `FinalMonthlyRequiredHours` اجازه انتساب جدید نمی‌دهد. اگر نیروی کافی نباشد، برخی شیفت‌ها بدون انتساب می‌مانند و در خروجی نیز خالی گزارش می‌شوند تا اپراتور تصمیم انسانی بگیرد (استخدام نیروی شیفت‌پرکن، اضافه‌کار دستی، جابجایی از بخش دیگر و …). |
| **انعطاف‌پذیر (تقسیم اضافه‌کار)** | `EnforceProductivityHours = false` و یک وزن برای `SoftWeights.ProductivityOvertimeWeight` تعیین کنید (مثلاً 2.0 یا بیشتر). | الگوریتم مجاز است ساعات مازاد را بین همان کاربران فعال تقسیم کند، اما برای هر ساعت اضافه جریمه به تابع هدف اضافه می‌شود. مقدار مازاد در خروجی (`Statistics.ProductivityOvertimeByUser`) ثبت و قابل گزارش‌دهی به HR/مالی است. |

نکات پیاده‌سازی:

- اگر می‌خواهید تنها برخی دپارتمان‌ها رویکرد نرم داشته باشند، برای همان بخش در جدول `DepartmentSchedulingSettings` مقادیر فوق را override کنید.
- در سناریوی Rolling Horizon نیز همین تنظیمات اعمال می‌شود؛ یعنی پنجره جدید اگر حالت سخت‌گیرانه داشته باشد، شیفت حل‌نشده بدون انتساب می‌ماند و در `RollingHorizonWindowResultDto.Violations` ذکر می‌شود.
- KPI `ProductivityComplianceRate` نمای کلی رعایت سقف‌ها را می‌دهد؛ اگر این عدد به ۱ نزدیک باشد یعنی بیشتر نیروها در همان سقف متوقف شده‌اند (حالت سخت). اگر وزن نرم قرار داده باشید و مقدار به زیر ۱ افت کند، می‌دانید چند درصد اضافه‌کار برنامه‌ریزی شده است.

## ۱۰. نتیجه‌گیری

سامانه شیفت‌یار بستر قدرتمندی برای مدیریت پیچیدگی‌های بیمارستانی فراهم کرده است؛ با این حال برای رسیدن به برنامه‌ریزی کاملاً منطبق با آیین‌نامه‌های بهره‌وری و شرایط اضطراری، لازم است:

1. خروجی سرویس بهره‌وری در قیود الگوریتم‌ها لحاظ شد و سقف ساعات موظفی اکنون قابل نظارت است.
2. ماژول Rolling Horizon اجرای Re-schedule جزئی را ممکن کرده است.
3. اعتبارسنجی ورودی و KPIهای مدیریتی به خروجی‌ها افزوده شد، هرچند تکمیل زنجیره تست و پایش رویدادهای تعطیلی همچنان در دست اقدام است.

با انجام این بهبودها، سیستم می‌تواند پاسخ‌گوی تمامی الزامات عملیاتی و بهداشتی مراکز درمانی بزرگ در ایران باشد.

